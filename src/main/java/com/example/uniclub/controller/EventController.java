package com.example.uniclub.controller;

import com.example.uniclub.dto.ApiResponse;
import com.example.uniclub.dto.request.*;
import com.example.uniclub.dto.response.EventResponse;
import com.example.uniclub.dto.response.EventStaffResponse;
import com.example.uniclub.dto.response.EventWalletResponse;
import com.example.uniclub.entity.Event;
import com.example.uniclub.enums.EventStatusEnum;
import com.example.uniclub.exception.ApiException;
import com.example.uniclub.security.CustomUserDetails;
import com.example.uniclub.service.*;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springdoc.core.annotations.ParameterObject;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/events")
@RequiredArgsConstructor
public class EventController {

    private final EventService eventService;
    private final EventPointsService eventPointsService;
    private final EventStaffService eventStaffService;
    private final EventWalletService eventWalletService;
    private final EventSettlementService eventSettlementService;
    private final AttendanceService attendanceService;

    // =========================================================
    // üîπ 1. CRUD APIs
    // =========================================================

    /** üü¢ T·∫°o m·ªõi s·ª± ki·ªán (Admin / Leader) */
    @PostMapping
    @PreAuthorize("hasAnyRole('ADMIN','CLUB_LEADER')")
    public ResponseEntity<ApiResponse<EventResponse>> createEvent(@Valid @RequestBody EventCreateRequest req) {
        return ResponseEntity.ok(ApiResponse.ok(eventService.create(req)));
    }

    /** üü¢ L·∫•y chi ti·∫øt 1 s·ª± ki·ªán */
    @GetMapping("/{id}")
    public ResponseEntity<ApiResponse<EventResponse>> get(@PathVariable Long id) {
        return ResponseEntity.ok(ApiResponse.ok(eventService.get(id)));
    }

    /** üü¢ L·∫•y danh s√°ch t·∫•t c·∫£ s·ª± ki·ªán (ph√¢n trang) */
    @GetMapping
    public ResponseEntity<Page<EventResponse>> list(@ParameterObject Pageable pageable) {
        return ResponseEntity.ok(eventService.list(pageable));
    }

    /** üü¢ UniStaff duy·ªát / t·ª´ ch·ªëi s·ª± ki·ªán */
    @PutMapping("/events/{id}/status")
    @PreAuthorize("hasAnyRole('UNIVERSITY_STAFF','ADMIN')")
    public ResponseEntity<ApiResponse<String>> updateStatus(
            @PathVariable Long id,
            @RequestBody EventStatusUpdateRequest req,
            @AuthenticationPrincipal CustomUserDetails principal) {

        String msg;
        if (req.getStatus() == EventStatusEnum.APPROVED) {
            msg = eventService.reviewByUniStaff(id, true, principal, req.getBudgetPoints());
        } else if (req.getStatus() == EventStatusEnum.REJECTED) {
            msg = eventService.reviewByUniStaff(id, false, principal, null);
        } else {
            throw new ApiException(HttpStatus.BAD_REQUEST, "Ch·ªâ UniStaff ƒë∆∞·ª£c set APPROVED/REJECTED.");
        }
        return ResponseEntity.ok(new ApiResponse<>(true, msg, null));
    }


    /** üü¢ X√≥a s·ª± ki·ªán (Admin / Leader) */
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAnyRole('ADMIN','CLUB_LEADER')")
    public ResponseEntity<ApiResponse<String>> delete(@PathVariable Long id) {
        eventService.delete(id);
        return ResponseEntity.ok(ApiResponse.msg("Deleted"));
    }

    // =========================================================
    // üîπ 2. PARTICIPATION
    // =========================================================

    /** üü¢ Sinh vi√™n ƒëƒÉng k√Ω tham gia s·ª± ki·ªán */
    @PostMapping("/register")
    @PreAuthorize("hasRole('STUDENT')")
    public ResponseEntity<ApiResponse<String>> register(@AuthenticationPrincipal CustomUserDetails principal,
                                                        @Valid @RequestBody EventRegisterRequest req) {
        return ResponseEntity.ok(ApiResponse.msg(eventPointsService.register(principal, req)));
    }

    /** üü¢ Sinh vi√™n check-in tham gia s·ª± ki·ªán */
    @PostMapping("/checkin")
    @PreAuthorize("hasRole('STUDENT')")
    public ResponseEntity<ApiResponse<String>> checkin(@AuthenticationPrincipal CustomUserDetails principal,
                                                       @Valid @RequestBody EventCheckinRequest req) {
        return ResponseEntity.ok(ApiResponse.msg(eventPointsService.checkin(principal, req)));
    }

    /** üü¢ Sinh vi√™n h·ªßy ƒëƒÉng k√Ω s·ª± ki·ªán */
    @PutMapping("/{eventId}/cancel")
    @PreAuthorize("hasRole('STUDENT')")
    public ResponseEntity<ApiResponse<String>> cancelRegistration(@AuthenticationPrincipal CustomUserDetails principal,
                                                                  @PathVariable Long eventId) {
        return ResponseEntity.ok(ApiResponse.msg(eventPointsService.cancelRegistration(principal, eventId)));
    }

    /** üü¢ K·∫øt th√∫c s·ª± ki·ªán (Leader / UniStaff) */
    @PutMapping("/end")
    @PreAuthorize("hasAnyRole('CLUB_LEADER','UNIVERSITY_STAFF')")
    public ResponseEntity<ApiResponse<String>> endEvent(@AuthenticationPrincipal CustomUserDetails principal,
                                                        @Valid @RequestBody EventEndRequest req) {
        return ResponseEntity.ok(ApiResponse.msg(eventPointsService.endEvent(principal, req)));
    }

    // =========================================================
    // üîπ 3. LOOKUP
    // =========================================================

    /** üü¢ L·∫•y danh s√°ch s·ª± ki·ªán c·ªßa 1 CLB */
    @GetMapping("/club/{clubId}")
    public ResponseEntity<List<EventResponse>> getByClubId(@PathVariable Long clubId) {
        return ResponseEntity.ok(eventService.getByClubId(clubId));
    }

    /** üü¢ L·∫•y s·ª± ki·ªán b·∫±ng m√£ check-in */
    @GetMapping("/code/{code}")
    public ResponseEntity<ApiResponse<EventResponse>> getByCheckInCode(@PathVariable String code) {
        return ResponseEntity.ok(ApiResponse.ok(eventService.findByCheckInCode(code)));
    }

    /** üü¢ L·∫•y danh s√°ch ƒëƒÉng k√Ω c·ªßa 1 s·ª± ki·ªán */
    @GetMapping("/{eventId}/registrations")
    public ResponseEntity<ApiResponse<?>> getEventRegistrations(@PathVariable Long eventId) {
        return ResponseEntity.ok(ApiResponse.ok(eventPointsService.getEventRegistrations(eventId)));
    }

    /** üü¢ T√≥m t·∫Øt s·ª± ki·ªán (th·ªëng k√™ tham gia, ƒëi·ªÉm, v√≠...) */
    @GetMapping("/{eventId}/summary")
    public ResponseEntity<ApiResponse<?>> getEventSummary(@PathVariable Long eventId) {
        return ResponseEntity.ok(ApiResponse.ok(eventPointsService.getEventSummary(eventId)));
    }

    /** üü¢ L·∫•y chi ti·∫øt v√≠ c·ªßa s·ª± ki·ªán */
    @GetMapping("/{eventId}/wallet/detail")
    public ResponseEntity<ApiResponse<EventWalletResponse>> getEventWalletDetail(@PathVariable Long eventId) {
        return ResponseEntity.ok(ApiResponse.ok(eventWalletService.getEventWalletDetail(eventId)));
    }

    /** üü¢ L·∫•y danh s√°ch s·ª± ki·ªán s·∫Øp di·ªÖn ra (Student) */
    @GetMapping("/upcoming")
    public ResponseEntity<ApiResponse<?>> getUpcomingEvents() {
        return ResponseEntity.ok(ApiResponse.ok(eventService.getUpcomingEvents()));
    }

    /** üü¢ L·∫•y danh s√°ch s·ª± ki·ªán ƒëang ho·∫°t ƒë·ªông */
    @GetMapping("/active")
    public ResponseEntity<ApiResponse<?>> getActiveEvents() {
        return ResponseEntity.ok(ApiResponse.ok(eventService.getActiveEvents()));
    }

    /** üü¢ L·∫•y danh s√°ch s·ª± ki·ªán c·ªßa b·∫£n th√¢n (Student) */
    @GetMapping("/my")
    public ResponseEntity<ApiResponse<?>> getMyEvents(@AuthenticationPrincipal CustomUserDetails principal) {
        return ResponseEntity.ok(ApiResponse.ok(eventService.getMyEvents(principal)));
    }

    /** üü¢ L·∫•y danh s√°ch s·ª± ki·ªán ƒë√£ ƒëƒÉng k√Ω (Student) */
    @GetMapping("/my-registrations")
    public ApiResponse<?> getMyRegisteredEvents(@AuthenticationPrincipal CustomUserDetails principal) {
        return new ApiResponse<>(true, "success", eventPointsService.getMyRegisteredEvents(principal));
    }

    /** üü¢ L·ªçc s·ª± ki·ªán theo t√™n / ng√†y / tr·∫°ng th√°i */
    @GetMapping("/filter")
    public ResponseEntity<Page<EventResponse>> filter(@RequestParam(required = false) String name,
                                                      @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate date,
                                                      @RequestParam(required = false) EventStatusEnum status,
                                                      @ParameterObject Pageable pageable) {
        return ResponseEntity.ok(eventService.filter(name, date, status, pageable));
    }

    /** üü¢ L·∫•y danh s√°ch s·ª± ki·ªán ƒë·ªìng t·ªï ch·ª©c c·ªßa 1 CLB */
    @GetMapping("/club/{clubId}/cohost")
    public ResponseEntity<List<EventResponse>> getCoHostedEvents(@PathVariable Long clubId) {
        return ResponseEntity.ok(eventService.getCoHostedEvents(clubId));
    }

    // =========================================================
    // üîπ 4. SETTLEMENT & COMPLETE
    // =========================================================

    /** üü¢ UniStaff th·ª±c hi·ªán settle (ch·ªët ƒëi·ªÉm + ho√†n v√≠) */
    @PostMapping("/{eventId}/settle")
    public ResponseEntity<ApiResponse<String>> settleEvent(@PathVariable Long eventId) {
        Event event = eventService.getEntity(eventId);
        eventSettlementService.settleEvent(event);
        eventWalletService.returnSurplusToClubs(event);
        return ResponseEntity.ok(ApiResponse.msg("Event settled successfully"));
    }

    /** üü¢ ƒê√°nh d·∫•u ho√†n t·∫•t s·ª± ki·ªán (Leader / UniStaff) */
    @PostMapping("/{eventId}/complete")
    public ResponseEntity<ApiResponse<String>> completeEvent(@AuthenticationPrincipal CustomUserDetails principal,
                                                             @PathVariable Long eventId) {
        String msg = eventService.finishEvent(eventId, principal);
        return ResponseEntity.ok(ApiResponse.msg(msg));
    }

    // =========================================================
    // üîπ 5. CO-HOST
    // =========================================================

    /** üü¢ CLB ƒë·ªìng t·ªï ch·ª©c ph·∫£n h·ªìi l·ªùi m·ªùi (ƒë·ªìng √Ω / t·ª´ ch·ªëi) */
    @PostMapping("/{eventId}/cohost/respond")
    public ResponseEntity<ApiResponse<String>> respondCohost(@AuthenticationPrincipal CustomUserDetails principal,
                                                             @PathVariable Long eventId,
                                                             @RequestParam boolean accept) {
        String msg = eventService.respondCoHost(eventId, principal, accept);
        return ResponseEntity.ok(ApiResponse.msg(msg));
    }

    /** üü¢ Leader g·ª≠i s·ª± ki·ªán ƒë√£ duy·ªát co-host l√™n UniStaff */
    @PutMapping("/{eventId}/submit")
    public ResponseEntity<ApiResponse<String>> submitEventToUniStaff(@AuthenticationPrincipal CustomUserDetails principal,
                                                                     @PathVariable Long eventId) {
        String msg = eventService.submitEventToUniStaff(eventId, principal);
        return ResponseEntity.ok(ApiResponse.msg(msg));
    }

    // =========================================================
    // üîπ 6. STAFF
    // =========================================================

    /** üü¢ Ph√¢n c√¥ng th√†nh vi√™n l√†m staff s·ª± ki·ªán */
    @PostMapping("/{id}/staffs")
    public ResponseEntity<ApiResponse<EventStaffResponse>> assignStaff(@AuthenticationPrincipal CustomUserDetails principal,
                                                                       @PathVariable Long id,
                                                                       @RequestParam Long membershipId,
                                                                       @RequestParam(required = false) String duty) {
        return ResponseEntity.ok(ApiResponse.ok(eventStaffService.assignStaff(id, membershipId, duty)));
    }

    /** üü¢ G·ª° staff kh·ªèi s·ª± ki·ªán */
    @DeleteMapping("/{id}/staffs/{staffId}")
    public ResponseEntity<ApiResponse<String>> unassignStaff(@PathVariable Long id, @PathVariable Long staffId) {
        eventStaffService.unassignStaff(staffId);
        return ResponseEntity.ok(ApiResponse.msg("Staff unassigned successfully"));
    }

    /** üü¢ L·∫•y danh s√°ch staff c·ªßa s·ª± ki·ªán */
    @GetMapping("/{id}/staffs")
    public ResponseEntity<ApiResponse<List<EventStaffResponse>>> getEventStaffs(@PathVariable Long id) {
        return ResponseEntity.ok(ApiResponse.ok(eventService.getEventStaffList(id)));
    }

    // =========================================================
    // üîπ 7. ATTENDANCE
    // =========================================================

    /** üü¢ L·∫•y QR ƒëi·ªÉm danh (leader / staff) */
    @GetMapping("/{eventId}/attendance/qr")
    public ResponseEntity<ApiResponse<Map<String, Object>>> getAttendanceQr(@PathVariable Long eventId,
                                                                            @RequestParam(defaultValue = "START") String phase) {
        return ResponseEntity.ok(ApiResponse.ok(attendanceService.getQrTokenForEvent(eventId, phase)));
    }

    /** üü¢ X√°c minh ƒëi·ªÉm danh b·∫±ng userId */
    @PostMapping("/{eventId}/attendance/verify")
    public ResponseEntity<ApiResponse<String>> verifyAttendance(@PathVariable Long eventId, @RequestParam Long userId) {
        String msg = attendanceService.verifyAttendance(eventId, userId);
        return ResponseEntity.ok(ApiResponse.msg(msg));
    }
}
